<script>
  let scripts = 0, loadedScripts = 0
  function onLoadScript () {
    loadedScripts++
    if (loadedScripts < scripts || !window.setup) return
    if (document.readyState !== 'loading') window.setup.call(undefined, arguments)
    else window.addEventListener('DOMContentLoaded', window.setup.bind(undefined, arguments))
  }
  
  (function () {
    const typekitKey = 'typekit_styles_cache'  

    let polyfills = []
    if (!('fetch' in window)) polyfills.push('fetch')
    if (!('Promise' in window)) polyfills.push('Promise')
    if (!('isArray' in Array)) polyfills.push('Array.isArray')
    if (!('keys' in Object)) polyfills.push('Object.keys')
    if (!('assign' in Object)) polyfills.push('Object.assign')
    if (!('classList' in Element.prototype)) polyfills.push('Element.prototype.classList')
    if (!('includes' in String.prototype)) polyfills.push('String.prototype.includes')
    if (polyfills.length > 0) {
      loadScript('https://cdn.polyfill.io/v2/polyfill.min.js?features=' + polyfills.join(',') + '&flags=gated,always&ua=chrome/50', setup)
    } else {
      setup()
    }

    function setup() {
      document.documentElement.classList.remove('no-js')

      initTypekit()
      setPrevious()
      loadPageScripts()
    }

    function setPrevious() {
      window.onbeforeunload = function () {
        ('sessionStorage' in window) && sessionStorage.setItem('previous', '{{page.url}}')
      }
    }

    function loadScript(url, callback) {
      let scriptEl = document.createElement('script')
      scriptEl.async = true
      scriptEl.defer = true
      let src = url
      if (src.includes('recaptcha/api.js')) {
        src += (src.includes('.js?') ? '&' : '?') + 'onload=onLoadScript'
      } else {
        scriptEl.onload = callback
      }
      scriptEl.src = src
      document.head.appendChild(scriptEl)
      scripts++
    }

    function makeStyle(cssText) {
      const styleEl = document.createElement('style')
      styleEl.type = 'text/css'
      if (styleEl.styleSheet) styleEl.styleSheet.cssText = cssText
      else styleEl.appendChild(document.createTextNode(cssText))
      document.head.appendChild(styleEl)
    }

    function loadPageScripts() {
      [
        {% for script in include.files %}'{{script}}',{% endfor %}
      ].forEach(function(script) {
        loadScript(script, onLoadScript)
      })
    }

    function initTypekit() {
      if ('sessionStorage' in window && sessionStorage.getItem(typekitKey)) {
        makeStyle(sessionStorage.getItem(typekitKey))
      } else {
        loadScript('https://use.typekit.net/{{site.secrets.typekit}}.js', function () {
          Typekit.load({ active: cacheTypekitStyles, classes: false })
        })
      }
    }

    function cacheTypekitStyles() {
      if (!('sessionStorage' in window)) return
      const styles = Array.from(document.head.getElementsByTagName('style'))
        .filter(function (child) {
          return child.styleSheet ?
            child.styleSheet.cssText.includes('typekit') :
            child.innerHTML.includes('typekit')
        })
        .map(function (child) {
          return child.styleSheet ? child.styleSheet.cssText : child.innerHTML
        })
        .join('\n')

      sessionStorage.setItem(typekitKey, styles)
    }
  })()
</script>